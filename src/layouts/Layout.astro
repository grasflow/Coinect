---
import "../styles/global.css";
import { MainNavbar } from "@/components/features/auth/MainNavbar";
import { BottomNavigation } from "@/components/features/navigation/BottomNavigation";
import LayoutWrapper from "@/components/LayoutWrapper";

interface Props {
  title?: string;
}

const { title = "Coinect" } = Astro.props;

// Bezpieczna weryfikacja użytkownika przez serwer Supabase
// getUser() weryfikuje token z serwerem, w przeciwieństwie do getSession() która tylko czyta cookies
const {
  data: { user },
} = await Astro.locals.supabase.auth.getUser();

// Middleware already handles redirects, so user should always exist here
// If it doesn't, something is wrong with the route configuration
if (!user) {
  throw new Error("Unauthorized access - user required");
}

const { data: profile } = await Astro.locals.supabase
  .from("profiles")
  .select("full_name, email")
  .eq("id", user.id)
  .single();

const userName = profile?.full_name || "";
const userEmail = profile?.email || user.email || "";
---

<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

    <!-- Android/Chrome -->
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png" />

    <!-- Web App Manifest -->
    <link rel="manifest" href="/site.webmanifest" />

    <!-- Theme Color -->
    <meta name="theme-color" content="#ffffff" />
    <meta name="msapplication-TileColor" content="#ffffff" />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta
      property="og:description"
      content="Profesjonalne zarządzanie czasem pracy i fakturowanie dla freelancerów i małych firm"
    />
    <meta property="og:image" content="/open-graph.png" />
    <meta property="og:url" content="https://my.coinect.pl" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Coinect" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta
      name="twitter:description"
      content="Profesjonalne zarządzanie czasem pracy i fakturowanie dla freelancerów i małych firm"
    />
    <meta name="twitter:image" content="/open-graph.png" />

    <!-- Additional Meta -->
    <meta
      name="description"
      content="Profesjonalne zarządzanie czasem pracy i fakturowanie dla freelancerów i małych firm"
    />
    <meta name="keywords" content="zarządzanie czasem, fakturowanie, freelancer, faktury, time tracking" />
    <meta name="author" content="Coinect" />
  </head>
  <body>
    <MainNavbar userName={userName} userEmail={userEmail} client:load />

    <div id="content-wrapper" class="contents">
      <LayoutWrapper client:load>
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pb-24 min-[900px]:pb-8">
          <slot />
        </main>
      </LayoutWrapper>
    </div>

    <BottomNavigation client:load />
  </body>
</html>

<style>
  html,
  body {
    margin: 0;
    width: 100%;
    height: 100%;
  }
</style>
